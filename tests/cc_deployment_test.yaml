suite: "test deployment for kyverno cleanup controller"
release:
  name: kyverno
templates:
- charts/kyverno/templates/cleanup-controller/deployment.yaml
tests:
- it: cleanup controller (local clusters) - local container resources
  values: &localValues
  - ../values-subchart-overrides.yaml
  - ../values-local.yaml
  asserts:
  - matchRegex:
      path: spec.template.spec.containers[?(@.name == "controller")].resources.limits.cpu
      pattern: "^0.*"
  - matchRegex:
      path: spec.template.spec.containers[?(@.name == "controller")].resources.limits.memory
      pattern: "^[1-9].*"
  - matchRegex:
      path: spec.template.spec.containers[?(@.name == "controller")].resources.requests.cpu
      pattern: "^0.*"
  - matchRegex:
      path: spec.template.spec.containers[?(@.name == "controller")].resources.requests.memory
      pattern: "^0.*"
  - matchSnapshot:
      path: spec.template.spec
- it: cleanup controller (all clusters) - non-local container resources
  values: &overridesValues
  - ../values-subchart-overrides.yaml
  asserts:
  - matchRegex:
      path: spec.template.spec.containers[?(@.name == "controller")].resources.limits.cpu
      pattern: "^[1-9].*"
  - matchRegex:
      path: spec.template.spec.containers[?(@.name == "controller")].resources.limits.memory
      pattern: "^[1-9].*"
  - matchRegex:
      path: spec.template.spec.containers[?(@.name == "controller")].resources.requests.cpu
      pattern: "^[1-9].*"
  - matchRegex:
      path: spec.template.spec.containers[?(@.name == "controller")].resources.requests.memory
      pattern: "^[1-9].*"
  - matchSnapshot:
      path: spec.template.spec
- it: cleanup controller (all clusters) - ensure policyException feature is not present
  values: *overridesValues
  asserts:
  - notExists:
      path: spec.template.spec.containers[*].args[?(@ == '--enablePolicyException=true')]
  - matchSnapshot:
      path: spec.template.spec
- it: cleanup controller (all cluster types) - subchart ensure policyException feature is not present
  asserts:
  - notExists:
      path: spec.template.spec.containers[*].args[?(@ == '--enablePolicyException=false')]
  - matchSnapshot:
      path: spec.template.spec
- it: cleanup controller local cluster - logging custom verbosity
  values: *localValues
  asserts:
  - contains:
      path: &kyvernoContainerArgsPath spec.template.spec.containers[?(@.name == "controller")].args
      content:
        --v=3
  - matchSnapshot:
      path: spec.template.spec
- it: cleanup controller development cluster - logging custom verbosity
  values: *overridesValues
  asserts: &assertLoggingCustomVerbosity
  - contains:
      path: *kyvernoContainerArgsPath
      content:
        --v=-1
  - matchSnapshot:
      path: spec.template.spec
- it: cleanup controller production cluster - logging custom verbosity
  values:
  - ../values-subchart-overrides.yaml
  - ../values-production.yaml
  asserts: *assertLoggingCustomVerbosity
- it: cleanup controller - logging default verbosity
  asserts:
  - contains:
      path: *kyvernoContainerArgsPath
      content:
        --v=2
  - matchSnapshot:
      path: spec.template.spec
- it: cleanup controller - logging default text format
  asserts: &assertLoggingTextFormat
  - contains:
      path: *kyvernoContainerArgsPath
      content:
        --loggingFormat=text
  - matchSnapshot:
      path: spec.template.spec
- it: cleanup controller local cluster - logging text format
  values: *localValues
  asserts: *assertLoggingTextFormat
- it: cleanup controller development cluster - logging text format
  values: *overridesValues
  asserts: *assertLoggingTextFormat
- it: cleanup controller production cluster - logging text format
  values:
  - ../values-subchart-overrides.yaml
  - ../values-production.yaml
  asserts: *assertLoggingCustomVerbosity
- it: cleanup controller - logging default verbosity
  asserts: *assertLoggingTextFormat
